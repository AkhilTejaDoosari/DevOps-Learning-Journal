# **05. Users & Groups — Who Can Access What**
> Understanding system identity and access control

---

## What We'll Cover

- [1. Why User Management Isn't Optional](#1-why-user-management-isnt-optional)
- [2. How Linux Actually Identifies Users](#2-how-linux-actually-identifies-users)
- [3. The Files That Control Everything](#3-the-files-that-control-everything)
- [4. Creating Users (The Right Way)](#4-creating-users-the-right-way)
- [5. Managing Groups (Organization Matters)](#5-managing-groups)
- [6. sudo: Giving Power Safely](#6-sudo-giving-power-safely)
- [7. Real Production Scenarios](#7-real-production-scenarios)
- [8. Quick Command Reference](#8-quick-command-reference)

---

<details>
<summary><strong>1. Why User Management Isn't Optional</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

## The Reality

**Every production system is multi-user.**

Even if you think "it's just me," you actually have:
- Your personal account
- Root (superuser)
- Service accounts (nginx, postgresql, docker)
- Application users
- CI/CD agents

**Each needs proper isolation.**

---

## The Scenarios You'll Face

**Developer onboarding:**
- "Give Sarah access to the servers"
- "She needs to run docker commands"
- "Add her to the deployment team group"

**Application deployment:**
- "This app should run as its own user, not root"
- "Give it access to logs but not configs"

**Security incident:**
- "Lock John's account immediately"
- "Audit who has sudo access"
- "Remove all traces of the compromised account"

**Fast, correct user management = secure systems.**

---

## What Most People Get Wrong

They create users randomly without thinking about:
- **UIDs and GIDs** (the actual identity)
- **Primary vs supplementary groups** (access control)
- **Service accounts** (applications shouldn't run as you)
- **sudo configuration** (who can become root)

**After this file, you'll manage users like a sysadmin.**

</div>

</details>

---

<details>
<summary><strong>2. How Linux Actually Identifies Users</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

## The Core Truth

**Linux doesn't care about usernames. It cares about numbers.**

```
When you log in as "john":
     ↓
System maps "john" → UID 1000
     ↓
Kernel sees: UID 1000 wants to read file.txt
     ↓
Checks: Does UID 1000 have permission?
```

**Names are for humans. Numbers are for the kernel.**

---

## UID: Your Actual Identity

```bash
id
# Output: uid=1000(john) gid=1000(john) groups=1000(john),27(sudo),999(docker)
```

**Breaking it down:**
- `uid=1000(john)` - Your user ID is 1000, name is john
- `gid=1000(john)` - Your primary group ID is 1000
- `groups=...` - You're also in sudo (27) and docker (999)

---

## UID Ranges: Who Gets What Number

| UID Range | Purpose | Examples |
|-----------|---------|----------|
| **0** | Root (superuser) | The boss |
| **1-999** | System accounts | nginx, postgres, mysql |
| **1000+** | Regular users | You, developers, admins |

**Why this matters:** System accounts have UIDs < 1000 by convention. This prevents conflicts.

---

## GID: Group Identity

Every user has:
- **One primary group** (their default)
- **Multiple supplementary groups** (for access control)

```bash
id john
# uid=1000(john) gid=1000(john) groups=1000(john),27(sudo),999(docker)
#                ↑ primary      ↑ supplementary groups
```

---

## Real Scenario: Permission Denied Mystery

```bash
$ docker ps
permission denied
```

**What's wrong?**

```bash
id
# uid=1000(john) gid=1000(john) groups=1000(john)
# Missing: docker group
```

**User isn't in the docker group!**

**Fix:**
```bash
sudo usermod -aG docker john
# Log out and back in
docker ps
# Works now
```

---

## Key Takeaway

**Usernames = convenience for humans**  
**UIDs = actual identity for the kernel**  
**GIDs = group membership for access control**

**Understand the numbers, understand the system.**

</div>

</details>

---

<details>
<summary><strong>3. The Files That Control Everything</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

## /etc/passwd: User Database

**Every user on the system has an entry here.**

```bash
cat /etc/passwd
```

**Format:**
```
username:x:UID:GID:full_name:home_dir:shell
```

**Example:**
```
john:x:1000:1000:John Doe:/home/john:/bin/bash
```

**Fields:**
1. `john` - username
2. `x` - password placeholder (actual password in /etc/shadow)
3. `1000` - UID
4. `1000` - primary GID
5. `John Doe` - full name (GECOS field)
6. `/home/john` - home directory
7. `/bin/bash` - default shell

---

## /etc/shadow: Password Storage

**Where encrypted passwords actually live.**

```bash
sudo cat /etc/shadow
```

**Format:**
```
username:$6$encrypted_password:lastchange:min:max:warn:inactive:expire
```

**Why separate from /etc/passwd?**

`/etc/passwd` is world-readable (everyone can see UIDs, shells, etc.)  
`/etc/shadow` is root-only (passwords must be protected)

---

## /etc/group: Group Database

**Every group on the system.**

```bash
cat /etc/group
```

**Format:**
```
groupname:x:GID:member1,member2,member3
```

**Example:**
```
docker:x:999:john,sarah
```

**Fields:**
1. `docker` - group name
2. `x` - password placeholder
3. `999` - GID
4. `john,sarah` - members (comma-separated)

---

## Quick Lookup Commands

**Find your entry:**
```bash
grep $USER /etc/passwd
```

**Find a group:**
```bash
grep docker /etc/group
```

**List all groups you're in:**
```bash
groups
# Output: john sudo docker
```

**Get detailed info:**
```bash
getent group docker
# Output: docker:x:999:john,sarah
```

---

## Key Files Summary

| File | What It Stores | Who Can Read |
|------|---------------|--------------|
| `/etc/passwd` | User accounts (UID, home, shell) | Everyone |
| `/etc/shadow` | Encrypted passwords | Root only |
| `/etc/group` | Group definitions | Everyone |
| `/etc/gshadow` | Group passwords | Root only |
| `/etc/sudoers` | sudo permissions | Root only |

**Never edit these directly. Use the proper commands.**

</div>

</details>

---

<details>
<summary><strong>4. Creating Users (The Right Way)</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

## The Basic Command

```bash
sudo useradd sarah
```

**But wait! This creates a user with:**
- ❌ No home directory
- ❌ No shell set
- ❌ No password

**They can't actually log in.**

---

## The Right Way: Full User Setup

```bash
# Create with home directory and bash shell
sudo useradd -m -s /bin/bash sarah

# Set password
sudo passwd sarah
# Enter password when prompted

# Add to groups
sudo usermod -aG sudo,docker sarah
```

**Now the user can:**
- ✅ Log in
- ✅ Use bash
- ✅ Have a home directory
- ✅ Run docker commands
- ✅ Use sudo

---

## useradd Options That Matter

**-m** - Create home directory
```bash
sudo useradd -m sarah
# Creates /home/sarah
```

**-s** - Set shell
```bash
sudo useradd -m -s /bin/bash sarah
# User gets bash instead of default sh
```

**-u** - Specify UID
```bash
sudo useradd -m -u 1500 sarah
# Useful for keeping UIDs consistent across systems
```

**-G** - Add to groups
```bash
sudo useradd -m -s /bin/bash -G docker,sudo sarah
# User starts with docker and sudo groups
```

**-r** - System account (for services)
```bash
sudo useradd -r -s /usr/sbin/nologin appuser
# UID < 1000, can't log in interactively
```

---

## Setting and Changing Passwords

**For a new user:**
```bash
sudo passwd sarah
# Enter new password twice
```

**User changing their own password:**
```bash
passwd
# Enter old password, then new password twice
```

**Force password change on next login:**
```bash
sudo passwd -e sarah
```

**Lock an account (disable login):**
```bash
sudo passwd -l sarah
```

**Unlock it:**
```bash
sudo passwd -u sarah
```

---

## Modifying Existing Users

**Change shell:**
```bash
sudo usermod -s /bin/zsh sarah
```

**Add to a group (IMPORTANT - use -aG):**
```bash
sudo usermod -aG docker sarah
# -a = append (keeps existing groups)
# -G = groups

# ❌ WRONG:
sudo usermod -G docker sarah
# This REPLACES all groups with just docker
```

**Change UID:**
```bash
sudo usermod -u 2000 sarah
```

**Change home directory:**
```bash
sudo usermod -d /new/home -m sarah
# -m moves files to new location
```

---

## Deleting Users

**Delete user, keep their files:**
```bash
sudo userdel sarah
```

**Delete user AND their home directory:**
```bash
sudo userdel -r sarah
```

**Best practice when someone leaves:**
```bash
# 1. Lock account first
sudo passwd -l sarah

# 2. Backup their files
sudo tar -czf /backup/sarah-$(date +%F).tar.gz /home/sarah

# 3. Then delete
sudo userdel -r sarah
```

---

## Real Scenario: New Developer Onboarding

```bash
# Create full user account
sudo useradd -m -s /bin/bash sarah

# Set initial password
sudo passwd sarah

# Add to necessary groups
sudo usermod -aG sudo,docker,developers sarah

# Verify
id sarah
# uid=1001(sarah) gid=1001(sarah) groups=1001(sarah),27(sudo),999(docker),3000(developers)

# They're ready to work
```

---

## Key Takeaway

**Always use -m** (create home directory)  
**Always use -s /bin/bash** (set proper shell)  
**Always use -aG** (append to groups, don't replace)  
**Always set a password** (or they can't log in)

</div>

</details>

---

<details>
<summary><strong>5. Managing Groups (Organization Matters)</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

## Why Groups Exist

**Problem:** 10 developers need access to `/var/www/html`

**Bad solution:** Give each user individual permissions  
**Good solution:** Create a group, add them to it, set group permissions

**Groups = organized access control.**

---

## Creating Groups

```bash
sudo groupadd developers
```

**With specific GID:**
```bash
sudo groupadd -g 3000 developers
```

**Check it exists:**
```bash
getent group developers
# Output: developers:x:3000:
```

---

## Adding Users to Groups

**Method 1: usermod (recommended)**
```bash
sudo usermod -aG developers sarah
```

**Method 2: gpasswd**
```bash
sudo gpasswd -a sarah developers
```

**Both do the same thing. Use usermod for consistency.**

---

## Removing Users from Groups

```bash
sudo gpasswd -d sarah developers
```

**Verify:**
```bash
groups sarah
# Output should NOT include developers
```

---

## Primary vs Supplementary Groups

### **Primary Group**
- Every user has exactly ONE
- Usually same name as username
- Default group for new files

```bash
id john
# uid=1000(john) gid=1000(john) ...
#                ↑ primary group
```

### **Supplementary Groups**
- Additional groups for access control
- User can be in many

```bash
id john
# ... groups=1000(john),27(sudo),999(docker),3000(developers)
#                       ↑ supplementary groups
```

**When john creates a file, it belongs to john:john (primary group)**

---

## Changing Primary Group

```bash
sudo usermod -g developers john
```

**Now files john creates will belong to `john:developers` instead of `john:john`**

**Rarely needed. Usually you just add supplementary groups.**

---

## Real Scenario: Shared Team Directory

**Setup:**
```bash
# Create group for team
sudo groupadd webdevs

# Add team members
sudo usermod -aG webdevs john
sudo usermod -aG webdevs sarah
sudo usermod -aG webdevs mike

# Set up directory
sudo mkdir -p /var/www/team-project
sudo chgrp webdevs /var/www/team-project
sudo chmod 775 /var/www/team-project

# Now everyone in webdevs can read/write
ls -ld /var/www/team-project
# drwxrwxr-x ... webdevs
```

---

## Checking Group Membership

**Your groups:**
```bash
groups
```

**Someone else's groups:**
```bash
groups sarah
```

**Who's in a specific group:**
```bash
getent group docker
# docker:x:999:john,sarah,mike
```

**List all groups on system:**
```bash
cat /etc/group
```

---

## Modifying Groups

**Rename:**
```bash
sudo groupmod -n engineers developers
```

**Change GID:**
```bash
sudo groupmod -g 3001 engineers
```

**Delete:**
```bash
sudo groupdel engineers
```

**Note:** Can't delete a group if it's someone's primary group.

---

## Key Takeaway

**Groups = organized access control**  
**Primary group** = one per user, for new files  
**Supplementary groups** = many, for permissions  
**usermod -aG** = add to group safely

</div>

</details>

---

<details>
<summary><strong>6. sudo: Giving Power Safely</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

## What sudo Actually Does

**Lets normal users run commands as root (or other users) when needed.**

**Why not just log in as root?**
1. **Audit trail** - you know who did what
2. **Safer** - less time spent with root powers
3. **Granular** - can limit which commands

---

## Giving Someone sudo Access

**On Ubuntu/Debian:**
```bash
sudo usermod -aG sudo sarah
```

**On RHEL/CentOS:**
```bash
sudo usermod -aG wheel sarah
```

**That's it. Now sarah can use sudo.**

---

## Testing sudo Access

```bash
# Try running something as root
sudo whoami
# Output: root

# Check what you can do
sudo -l
# Shows your sudo privileges
```

---

## How sudo Actually Works

**When you run:**
```bash
sudo systemctl restart nginx
```

**What happens:**
1. sudo checks `/etc/sudoers` - does your user have permission?
2. Prompts for YOUR password (not root's)
3. Elevates privileges
4. Runs the command as root
5. Logs the action

**Your password is cached for 15 minutes** (configurable)

---

## The /etc/sudoers File

**NEVER edit directly. Use visudo:**

```bash
sudo visudo
```

**Why visudo?** Validates syntax before saving. Direct edits can lock you out.

---

## Common sudoers Patterns

**Give user full sudo:**
```
sarah ALL=(ALL:ALL) ALL
```

**No password required (risky):**
```
sarah ALL=(ALL) NOPASSWD: ALL
```

**Specific commands only:**
```
sarah ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx
```

**Group-based (recommended):**
```
%sudo ALL=(ALL:ALL) ALL
# Anyone in 'sudo' group gets full sudo
```

---

## Real Scenario: CI/CD User Needs Limited sudo

**Problem:** Deploy script needs to restart services, but shouldn't have full root.

**Solution:**
```bash
# Create CI user
sudo useradd -r -s /bin/bash deploy-bot

# Create sudoers file for it
sudo visudo -f /etc/sudoers.d/deploy-bot

# Add this line:
deploy-bot ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart myapp, /usr/bin/systemctl status myapp

# Now deploy-bot can restart/check myapp, nothing else
```

---

## Checking sudo Privileges

**What can I run?**
```bash
sudo -l
```

**Test if you have sudo:**
```bash
sudo -v
# Returns 0 if you have sudo, 1 if not
```

---

## Revoking sudo Access

```bash
# Remove from sudo group
sudo gpasswd -d sarah sudo

# On RHEL/CentOS:
sudo gpasswd -d sarah wheel
```

---

## Key Takeaway

**sudo = temporary root powers**  
**Add to sudo/wheel group** = full sudo access  
**Edit with visudo** = safe config changes  
**Grant specific commands** = principle of least privilege

</div>

</details>

---

<details>
<summary><strong>7. Real Production Scenarios</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

## Scenario 1: New Developer Needs Full Setup

### **Problem:**
Sarah joins the team. Needs server access with docker and deployment permissions.

### **Solution:**

```bash
# Create user
sudo useradd -m -s /bin/bash sarah

# Set password
sudo passwd sarah

# Add to all necessary groups
sudo usermod -aG sudo,docker,developers sarah

# Verify
id sarah
groups sarah
```

**Sarah can now:**
- SSH in ✅
- Use docker ✅
- Deploy with sudo ✅
- Access team directories ✅

---

## Scenario 2: "Permission Denied" Running Docker

### **Problem:**
```bash
$ docker ps
permission denied while trying to connect to the Docker daemon socket
```

### **Diagnosis:**
```bash
groups
# Output: john (missing docker)
```

### **Solution:**
```bash
sudo usermod -aG docker john
```

**Important:** User must log out and back in!

```bash
# After re-login:
docker ps
# Works without sudo
```

---

## Scenario 3: Service Account for Application

### **Problem:**
Your Node.js app shouldn't run as your personal user or as root.

### **Solution:**

```bash
# Create system user (no home, no login)
sudo useradd -r -s /usr/sbin/nologin nodeapp

# Set up directories
sudo mkdir -p /opt/nodeapp
sudo chown nodeapp:nodeapp /opt/nodeapp

# In systemd service file:
[Service]
User=nodeapp
Group=nodeapp
WorkingDirectory=/opt/nodeapp
ExecStart=/usr/bin/node server.js
```

**Now app runs as `nodeapp`, isolated from other users.**

---

## Scenario 4: Team Shared Directory

### **Problem:**
3 developers need write access to `/var/www/project`

### **Solution:**

```bash
# Create team group
sudo groupadd webteam

# Add developers
sudo usermod -aG webteam alice
sudo usermod -aG webteam bob
sudo usermod -aG webteam charlie

# Set up directory
sudo chgrp webteam /var/www/project
sudo chmod 775 /var/www/project

# Make new files inherit group (optional)
sudo chmod g+s /var/www/project
```

**Now all three can:**
- Read files ✅
- Write files ✅
- Create new files ✅

---

## Scenario 5: Employee Left, Need Cleanup

### **Problem:**
John left the company. Remove all access immediately.

### **Solution:**

```bash
# Step 1: Lock account (prevents login)
sudo passwd -l john

# Step 2: Kill any active sessions
sudo pkill -u john

# Step 3: Backup their files
sudo tar -czf /backups/john-$(date +%F).tar.gz /home/john

# Step 4: Check what they owned
find / -user john 2>/dev/null

# Step 5: Delete user
sudo userdel -r john

# Step 6: Audit sudo logs
sudo grep john /var/log/auth.log
```

---

## Scenario 6: Can't sudo After Adding to Group

### **Problem:**
```bash
sudo usermod -aG sudo sarah
# Sarah still can't sudo
```

### **Diagnosis:**
**Group changes don't take effect until re-login!**

### **Solution:**
```bash
# Sarah needs to:
logout
# Then log back in

# Or:
su - sarah
# Switch to a fresh login shell
```

---

## Scenario 7: Forgot Root Password

### **Problem:**
Locked out of root, need to reset.

### **Solution:**

**If you have sudo:**
```bash
sudo passwd root
```

**If you don't:**
1. Boot into single-user mode (GRUB menu)
2. Mount filesystem read-write
3. Reset with `passwd root`
4. Reboot

**Prevention: Always have at least one user with sudo.**

---

## Key Takeaway

**Always use service accounts** for applications  
**Always add to groups** instead of direct file permissions  
**Always lock before deleting** when someone leaves  
**Always log out/in** after group changes

</div>

</details>

---

<details>
<summary><strong>8. Quick Command Reference</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

## Checking Identity

```bash copy
id   # show your UID, GID, and groups
```

```bash copy
id sarah   # show sarah's identity
```

```bash copy
whoami   # show current username
```

```bash copy
groups   # show your groups
```

```bash copy
groups sarah   # show sarah's groups
```

---

## Creating Users

```bash copy
sudo useradd sarah   # create user (no home)
```

```bash copy
sudo useradd -m sarah   # create with home directory
```

```bash copy
sudo useradd -m -s /bin/bash sarah   # with home and bash shell
```

```bash copy
sudo useradd -m -s /bin/bash -G sudo,docker sarah   # with groups
```

```bash copy
sudo useradd -r -s /usr/sbin/nologin appuser   # system account (no login)
```

```bash copy
sudo useradd -m -u 1500 sarah   # specify UID
```

---

## Setting Passwords

```bash copy
sudo passwd sarah   # set password for sarah
```

```bash copy
passwd   # change your own password
```

```bash copy
sudo passwd -l sarah   # lock account (disable login)
```

```bash copy
sudo passwd -u sarah   # unlock account
```

```bash copy
sudo passwd -e sarah   # force password change on next login
```

---

## Modifying Users

```bash copy
sudo usermod -s /bin/zsh sarah   # change shell
```

```bash copy
sudo usermod -aG docker sarah   # add to group (append)
```

```bash copy
sudo usermod -aG sudo,docker sarah   # add to multiple groups
```

```bash copy
sudo usermod -u 2000 sarah   # change UID
```

```bash copy
sudo usermod -d /new/home -m sarah   # change and move home directory
```

```bash copy
sudo usermod -l newname oldname   # rename user
```

```bash copy
sudo usermod -g newgroup sarah   # change primary group
```

---

## Deleting Users

```bash copy
sudo userdel sarah   # delete user (keep files)
```

```bash copy
sudo userdel -r sarah   # delete user and home directory
```

---

## Creating Groups

```bash copy
sudo groupadd developers   # create group
```

```bash copy
sudo groupadd -g 3000 developers   # create with specific GID
```

---

## Managing Group Membership

```bash copy
sudo usermod -aG developers sarah   # add user to group
```

```bash copy
sudo gpasswd -a sarah developers   # add user to group (alternative)
```

```bash copy
sudo gpasswd -d sarah developers   # remove user from group
```

```bash copy
getent group developers   # show group members
```

```bash copy
getent group docker   # show who's in docker group
```

---

## Modifying Groups

```bash copy
sudo groupmod -n engineers developers   # rename group
```

```bash copy
sudo groupmod -g 3001 engineers   # change GID
```

```bash copy
sudo groupdel developers   # delete group
```

---

## sudo Management

```bash copy
sudo usermod -aG sudo sarah   # give sudo access (Ubuntu/Debian)
```

```bash copy
sudo usermod -aG wheel sarah   # give sudo access (RHEL/CentOS)
```

```bash copy
sudo gpasswd -d sarah sudo   # revoke sudo access
```

```bash copy
sudo -l   # show your sudo privileges
```

```bash copy
sudo -v   # verify you have sudo (test)
```

```bash copy
sudo visudo   # edit sudoers file safely
```

```bash copy
sudo visudo -f /etc/sudoers.d/custom   # edit custom sudoers file
```

---

## Viewing System Files

```bash copy
cat /etc/passwd   # view user database
```

```bash copy
sudo cat /etc/shadow   # view encrypted passwords
```

```bash copy
cat /etc/group   # view group database
```

```bash copy
grep sarah /etc/passwd   # find sarah's entry
```

```bash copy
grep docker /etc/group   # find docker group
```

---

## Checking Who's Logged In

```bash copy
who   # show logged-in users
```

```bash copy
w   # show who's logged in and what they're doing
```

```bash copy
last   # show login history
```

```bash copy
lastlog   # show last login for all users
```

---

## Killing User Sessions

```bash copy
sudo pkill -u sarah   # kill all processes owned by sarah
```

```bash copy
sudo pkill -9 -u sarah   # force kill all sarah's processes
```

```bash copy
sudo killall -u sarah   # kill all sarah's processes by name
```

---

## Switching Users

```bash copy
su - sarah   # switch to sarah (with login environment)
```

```bash copy
su sarah   # switch to sarah (keep current environment)
```

```bash copy
sudo su -   # become root with root's environment
```

```bash copy
sudo -i   # become root (same as sudo su -)
```

```bash copy
sudo -u sarah command   # run command as sarah
```

</div>

</details>

---

## What You Just Learned

✅ **UIDs and GIDs** — the actual identity (numbers, not names)  
✅ **Creating users properly** — useradd -m -s /bin/bash  
✅ **Group management** — primary vs supplementary  
✅ **sudo access** — giving power safely  
✅ **Service accounts** — apps shouldn't run as you  
✅ **Real scenarios** — onboarding, permissions, cleanup  

---

## What's Next

**File 06: Permissions & Ownership**
- Understanding rwx permissions
- chmod and chown mastery
- Special permissions (setuid, setgid, sticky bit)
- ACLs for fine-grained control

**You know who can access the system. Now let's control what they can do.**