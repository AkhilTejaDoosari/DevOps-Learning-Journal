# **05. Users & Groups — Managing Identity and Access**
> Understanding who can access the system and what they can do.

---

## Table of Contents
- [1. Why User Management Exists](#1-why-user-management-exists)
- [2. The Inside-Out View of Users](#2-the-inside-out-view-of-users)
- [3. Core Concepts](#3-core-concepts)
- [4. User Management Commands](#4-user-management-commands)
- [5. Group Management Commands](#5-group-management-commands)
- [6. Real Scenarios](#6-real-scenarios)
- [7. Quick Summary](#7-quick-summary)

---

<details>
<summary><strong>1. Why User Management Exists</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

Linux is a multi-user system.

Multiple people can access the same server simultaneously — each with their own account, files, and permissions.

Without user management:
- Everyone would share the root account
- No accountability for actions
- No way to limit access to sensitive files
- No separation between developers, testers, and operators

User and group management solves this by:
- Creating isolated accounts for each person
- Organizing users into groups (developers, devops, testers)
- Controlling who can read, write, or execute files
- Tracking who did what through audit logs

In production environments:
- Akhil (DevOps) gets sudo access to deploy infrastructure
- Navya (AI Engineer) gets access to model training directories
- Charan (Frontend Dev) gets access to web application code
- Each user has their own `/home` directory
- Groups control shared project access

</div>

</details>

---

<details>
<summary><strong>2. The Inside-Out View of Users</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

Every user in Linux is just a number — a **UID (User ID)**.

Every group is just a number — a **GID (Group ID)**.

The kernel only cares about numbers. Names are for humans.

```
User Layer (Human)
    ↓
/etc/passwd (Name → UID mapping)
    ↓
Kernel (Uses UID for permissions)
    ↓
Filesystem (Checks UID against file owner)
```

When you run `ls -l`:
```
-rw-r--r-- 1 akhil devops 2048 Nov 17 10:30 main.tf
```

The kernel sees:
```
-rw-r--r-- 1 1000 1000 2048 Nov 17 10:30 main.tf
```

- `akhil` = UID 1000
- `devops` = GID 1000

The system translates names to numbers using `/etc/passwd` and `/etc/group`.

</div>

</details>

---

<details>
<summary><strong>3. Core Concepts</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

### UID — User ID (LX-001)

Every user has a unique numeric identifier.

UID 0 is always root — the superuser with unlimited access.

**UID Ranges**:

| Range | Purpose |
|-------|---------|
| 0 | Root (superuser) |
| 1-200 | System accounts and services |
| 201-999 | Unprivileged system processes |
| 1000+ | Regular user accounts |

Example:
```bash
id akhil
```

Output:
```
uid=1000(akhil) gid=1000(devops) groups=1000(devops),27(sudo),999(docker)
```

- UID 1000 = akhil
- Primary GID 1000 = devops
- Supplementary groups: sudo, docker

---

### GID — Group ID (LX-002)

Every group has a unique numeric identifier.

Users can belong to multiple groups:
- **Primary group** — default group for new files
- **Supplementary groups** — additional access (sudo, docker, devops)

Example:
```bash
groups akhil
```

Output:
```
akhil : devops sudo docker
```

---

### Key Files (LX-003)

Linux stores user and group information in plain text files.

| File | Purpose | Permissions |
|------|---------|-------------|
| `/etc/passwd` | User account info (username, UID, home, shell) | World-readable |
| `/etc/shadow` | Encrypted passwords and aging settings | Root-only |
| `/etc/group` | Group definitions and members | World-readable |
| `/etc/gshadow` | Encrypted group passwords and admins | Root-only |
| `/etc/sudoers` | Sudo permissions (edit with `visudo`) | Root-only |

---

### /etc/passwd Structure (LX-004)

Each line represents one user:
```
akhil:x:1000:1000:Akhil Teja:/home/akhil:/bin/bash
```

Fields (separated by `:`):
1. **Username** — `akhil`
2. **Password placeholder** — `x` (actual password in `/etc/shadow`)
3. **UID** — `1000`
4. **GID** — `1000` (primary group)
5. **GECOS** — `Akhil Teja` (full name, contact info)
6. **Home directory** — `/home/akhil`
7. **Login shell** — `/bin/bash`

View it:
```bash
cat /etc/passwd | grep akhil
```

---

### /etc/shadow Structure (LX-005)

Stores encrypted passwords and aging policies.

```
akhil:$6$random$hash:19000:0:99999:7:::
```

Fields:
1. **Username** — `akhil`
2. **Encrypted password** — `$6$random$hash`
3. **Last password change** — days since Jan 1, 1970
4. **Minimum days** before password can change
5. **Maximum days** before password must change
6. **Warning days** before expiration
7. **Inactive days** after expiration
8. **Expiration date**
9. **Reserved**

Only root can read this file:
```bash
sudo cat /etc/shadow | grep akhil
```

---

### /etc/group Structure (LX-006)

Stores group information:
```
devops:x:1000:akhil,navya,charan
```

Fields:
1. **Group name** — `devops`
2. **Password placeholder** — `x`
3. **GID** — `1000`
4. **Members** — `akhil,navya,charan`

View it:
```bash
cat /etc/group | grep devops
```

---

### Primary vs Supplementary Groups (LX-007)

**Primary group**:
- Assigned during user creation
- Default group for new files
- Usually same name as username

**Supplementary groups**:
- Additional groups for access control
- Added with `usermod -aG`

Example:

Akhil's primary group is `devops`.

When akhil creates a file:
```bash
touch deployment.log
ls -l deployment.log
```

Output:
```
-rw-r--r-- 1 akhil devops 0 Nov 17 11:00 deployment.log
```

Owner = akhil, Group = devops (primary group).

But akhil is also in `sudo` and `docker` groups (supplementary).

This lets akhil:
- Run privileged commands (`sudo`)
- Manage containers (`docker`)

---

### GECOS Field (LX-008)

The **GECOS** field stores user metadata:
- Full name
- Room number
- Work phone
- Home phone
- Other info

Originally used for mainframe systems to route print jobs.

Now mostly used for full names.

Example:
```
akhil:x:1000:1000:Akhil Teja Doosari,DevOps Engineer,555-1234:/home/akhil:/bin/bash
```

Set during user creation or change with:
```bash
sudo chfn akhil
```

---

### Home Directory (LX-009)

Each user gets a private directory under `/home`.

Example:
```
/home/akhil
/home/navya
/home/charan
```

Root's home is `/root` (not `/home/root`).

Home directory contains:
- Personal files and projects
- Configuration files (`.bashrc`, `.ssh/`)
- Application data

View home:
```bash
echo $HOME
```

Output:
```
/home/akhil
```

---

### Login Shell (LX-010)

The shell launched when a user logs in.

Common shells:
- `/bin/bash` — default on most systems
- `/bin/zsh` — feature-rich alternative
- `/bin/sh` — minimal POSIX shell
- `/sbin/nologin` — denies login (for system accounts)

Check your shell:
```bash
echo $SHELL
```

Change shell:
```bash
chsh -s /bin/zsh
```

---

### sudo — Superuser Access (LX-011)

`sudo` lets regular users run commands as root.

Configured in `/etc/sudoers` (edit with `visudo`).

Add user to sudo group:
```bash
sudo usermod -aG sudo akhil
```

Now akhil can run:
```bash
sudo systemctl restart nginx
sudo apt update
```

Check sudo access:
```bash
sudo -l
```

---

### System Users vs Regular Users (LX-012)

**System users** (UID < 1000):
- Run daemons and services
- No login shell (`/sbin/nologin`)
- No home directory (or `/nonexistent`)
- Examples: `www-data`, `nginx`, `mysql`

**Regular users** (UID >= 1000):
- Interactive login
- Home directory
- Login shell
- Examples: `akhil`, `navya`, `charan`

View system users:
```bash
cat /etc/passwd | grep nologin
```

</div>

</details>

---

<details>
<summary><strong>4. User Management Commands</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

### useradd — Create Users

Creates a new user account.

**Basic syntax**:
```bash
sudo useradd username
```

**Common options**:

| Option | Description | Example |
|--------|-------------|---------|
| `-m` | Create home directory | `sudo useradd -m navya` |
| `-s <shell>` | Set login shell | `sudo useradd -s /bin/bash navya` |
| `-u <UID>` | Set specific UID | `sudo useradd -u 1500 navya` |
| `-g <group>` | Set primary group | `sudo useradd -g devops navya` |
| `-G <groups>` | Add to supplementary groups | `sudo useradd -G sudo,docker navya` |
| `-c "comment"` | Set GECOS field | `sudo useradd -c "Navya AI Engineer" navya` |

**Full example**:
```bash
sudo useradd -m -s /bin/bash -c "Navya AI Engineer" navya
```

This creates:
- User `navya`
- Home directory `/home/navya`
- Shell `/bin/bash`
- GECOS field "Navya AI Engineer"

---

### passwd — Set Passwords

Set or change user password.

```bash
sudo passwd navya
```

Output:
```
New password: 
Retype new password: 
passwd: password updated successfully
```

Users can change their own password:
```bash
passwd
```

---

### usermod — Modify Users

Change user account properties.

**Common options**:

| Option | Description | Example |
|--------|-------------|---------|
| `-s <shell>` | Change login shell | `sudo usermod -s /bin/zsh navya` |
| `-u <UID>` | Change UID | `sudo usermod -u 2001 navya` |
| `-g <group>` | Change primary group | `sudo usermod -g developers navya` |
| `-aG <group>` | Add to supplementary group | `sudo usermod -aG sudo navya` |
| `-l <newname>` | Change username | `sudo usermod -l navya-ml navya` |
| `-L` | Lock account | `sudo usermod -L navya` |
| `-U` | Unlock account | `sudo usermod -U navya` |

**Add user to docker group**:
```bash
sudo usermod -aG docker navya
```

**Change shell to zsh**:
```bash
sudo usermod -s /bin/zsh navya
```

**Lock account (disable login)**:
```bash
sudo usermod -L navya
```

---

### userdel — Delete Users

Remove a user account.

**Delete user (keep home directory)**:
```bash
sudo userdel navya
```

**Delete user and home directory**:
```bash
sudo userdel --remove navya
```

Or:
```bash
sudo userdel -r navya
```

This removes:
- User from `/etc/passwd`
- Entry from `/etc/shadow`
- Home directory `/home/navya`
- Mail spool

---

### id — View User Info

Display UID, GID, and group memberships.

```bash
id akhil
```

Output:
```
uid=1000(akhil) gid=1000(devops) groups=1000(devops),27(sudo),999(docker)
```

View your own info:
```bash
id
```

</div>

</details>

---

<details>
<summary><strong>5. Group Management Commands</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

### groupadd — Create Groups

Create a new group.

**Basic syntax**:
```bash
sudo groupadd developers
```

**Set specific GID**:
```bash
sudo groupadd -g 3000 developers
```

---

### groupmod — Modify Groups

Change group properties.

**Rename group**:
```bash
sudo groupmod -n engineers developers
```

**Change GID**:
```bash
sudo groupmod -g 2001 engineers
```

---

### groupdel — Delete Groups

Remove a group.

```bash
sudo groupdel developers
```

You can't delete a group if it's a user's primary group.

---

### gpasswd — Manage Group Members

Add or remove users from groups.

**Add user to group**:
```bash
sudo gpasswd -a navya developers
```

**Remove user from group**:
```bash
sudo gpasswd -d navya developers
```

**Set group administrators**:
```bash
sudo gpasswd -A akhil developers
```

Now akhil can manage the `developers` group.

---

### groups — View Group Memberships

See which groups a user belongs to.

```bash
groups navya
```

Output:
```
navya : developers sudo docker
```

View your own groups:
```bash
groups
```

</div>

</details>

---

<details>
<summary><strong>6. Real Scenarios</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

### Scenario 1: Onboard New DevOps Engineer

Akhil joins the team as a DevOps engineer.

```bash
# Create user with home directory
sudo useradd -m -s /bin/bash -c "Akhil Teja DevOps Engineer" akhil

# Set password
sudo passwd akhil

# Add to sudo group (admin access)
sudo usermod -aG sudo akhil

# Add to docker group (container management)
sudo usermod -aG docker akhil

# Verify
id akhil
```

Output:
```
uid=1000(akhil) gid=1000(akhil) groups=1000(akhil),27(sudo),999(docker)
```

---

### Scenario 2: Create Project Team

Set up a shared project for the devops team.

```bash
# Create devops group
sudo groupadd devops

# Add team members
sudo gpasswd -a akhil devops
sudo gpasswd -a navya devops
sudo gpasswd -a charan devops

# Create shared project directory
sudo mkdir /opt/devops-projects

# Set group ownership
sudo chown root:devops /opt/devops-projects

# Set permissions (group can write)
sudo chmod 775 /opt/devops-projects

# Verify
ls -ld /opt/devops-projects
```

Output:
```
drwxrwxr-x 2 root devops 4096 Nov 17 11:00 /opt/devops-projects
```

Now all devops group members can read and write to the shared directory.

---

### Scenario 3: Create Service Account

Create a deployment user for CI/CD pipelines.

```bash
# Create system user (no login)
sudo useradd -r -s /sbin/nologin -c "CI/CD Deployment User" deploy

# Create SSH directory
sudo mkdir /home/deploy/.ssh
sudo chmod 700 /home/deploy/.ssh

# Add public key
sudo vim /home/deploy/.ssh/authorized_keys

# Set ownership
sudo chown -R deploy:deploy /home/deploy

# Add to docker group
sudo usermod -aG docker deploy
```

The `deploy` user can now:
- Be used by Jenkins/GitHub Actions
- Run containers
- But cannot log in interactively

---

### Scenario 4: Remove User Who Left

Navya leaves the company.

```bash
# Lock account immediately
sudo usermod -L navya

# Back up home directory
sudo tar -czf navya-backup-$(date +%F).tar.gz /home/navya

# Move backup to archive
sudo mv navya-backup-*.tar.gz /backups/former-employees/

# Delete user and home directory
sudo userdel --remove navya

# Remove from shared groups
sudo gpasswd -d navya devops
sudo gpasswd -d navya docker

# Verify removal
id navya
```

Output:
```
id: 'navya': no such user
```

---

### Scenario 5: Grant Temporary Sudo Access

Charan needs sudo for one day to test deployment scripts.

```bash
# Add to sudo group
sudo usermod -aG sudo charan

# Verify
groups charan
```

Output:
```
charan : developers sudo docker
```

Next day, remove sudo:
```bash
sudo gpasswd -d charan sudo
```

---

### Scenario 6: Audit User Activity

Check who has sudo access:
```bash
grep sudo /etc/group
```

Output:
```
sudo:x:27:akhil,indhu
```

Check recent login activity:
```bash
last | head -20
```

Check failed login attempts:
```bash
sudo grep "Failed password" /var/log/auth.log
```

</div>

</details>

---

<details>
<summary><strong>7. Quick Summary</strong></summary>

<div style="margin-left: 16px; margin-right: 16px; margin-top: 8px; margin-bottom: 8px;">

- Every user has a **UID**, every group has a **GID**
- UID 0 = root, UID >= 1000 = regular users
- `/etc/passwd` stores user info, `/etc/shadow` stores passwords
- `/etc/group` stores group info
- `useradd -m` creates user with home directory
- `passwd` sets passwords
- `usermod -aG` adds users to supplementary groups
- `userdel --remove` deletes user and home directory
- `groupadd` creates groups
- `gpasswd -a` adds users to groups
- Primary group = default for new files
- Supplementary groups = additional access (sudo, docker)
- `sudo` grants root privileges to regular users

</div>

</details>

---